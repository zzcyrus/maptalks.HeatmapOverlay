/*!
 * maptalks.HeatmapOverlay v1.0.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.40.5 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,g){"use strict";var e,u,i,o={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},d=(e=function(t){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)},u=o.defaultRadius,e.prototype={_organiseData:function(t,e){var i=t[this._xField],a=t[this._yField],r=this._radi,n=this._data,s=this._max,h=this._min,o=t[this._valueField]||1,d=t.radius||this._cfgRadius||u;n[i]||(n[i]=[],r[i]=[]),n[i][a]?n[i][a]+=o:(n[i][a]=o,r[i][a]=d);var l=n[i][a];return s<l?(e?this.setDataMax(l):this._max=l,!1):l<h?(e?this.setDataMin(l):this._min=l,!1):{x:i,y:a,value:o,radius:d,min:h,max:s}},_unOrganizeData:function(){var t=[],e=this._data,i=this._radi;for(var a in e)for(var r in e[a])t.push({x:a,y:r,radius:i[a][r],value:e[a][r]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(0<arguments[0].length)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var i=this._organiseData(arguments[0],!0);i&&(0===this._data.length&&(this._min=this._max=i.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[i]}))}return this},setData:function(t){var e=t.data,i=e.length;this._data=[],this._radi=[];for(var a=0;a<i;a++)this._organiseData(e[a],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},e),a=function(){var n=function(t){var e=t.gradient||t.defaultGradient,i=document.createElement("canvas"),a=i.getContext("2d");i.width=256,i.height=1;var r=a.createLinearGradient(0,0,256,1);for(var n in e)r.addColorStop(n,e[n]);return a.fillStyle=r,a.fillRect(0,0,256,1),a.getImageData(0,0,256,1).data},p=function(t,e){var i=document.createElement("canvas"),a=i.getContext("2d"),r=t,n=t;if(i.width=i.height=2*t,1==e)a.beginPath(),a.arc(r,n,t,0,2*Math.PI,!1),a.fillStyle="rgba(0,0,0,1)",a.fill();else{var s=a.createRadialGradient(r,n,t*e,r,n,t);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),a.fillStyle=s,a.fillRect(0,0,2*t,2*t)}return i};function t(t){var e=t.container,i=this.shadowCanvas=document.createElement("canvas"),a=this.canvas=t.canvas||document.createElement("canvas"),r=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(t.container)||{});a.className="heatmap-canvas",this._width=a.width=i.width=t.width||+r.width.replace(/px/,""),this._height=a.height=i.height=t.height||+r.height.replace(/px/,""),this.shadowCtx=i.getContext("2d"),this.ctx=a.getContext("2d"),a.style.cssText=i.style.cssText="position:absolute;left:0;top:0;",e.style.position="relative",e.appendChild(a),this._palette=n(t),this._templates={},this._setStyles(t)}return t.prototype={renderPartial:function(t){0<t.data.length&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),0<t.data.length&&(this._drawAlpha(function(t){for(var e=[],i=t.min,a=t.max,r=t.radi,n=(t=t.data,Object.keys(t)),s=n.length;s--;)for(var h=n[s],o=Object.keys(t[h]),d=o.length;d--;){var l=o[d],u=t[h][l],c=r[h][l];e.push({x:h,y:l,value:u,radius:c})}return{min:i,max:a,data:e}}(t)),this._colorize())},_updateGradient:function(t){this._palette=n(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var e=this._min=t.min,i=this._max=t.max,a=(t=t.data||[]).length,r=1-this._blur;a--;){var n,s=t[a],h=s.x,o=s.y,d=s.radius,l=Math.min(s.value,i),u=h-d,c=o-d,_=this.shadowCtx;this._templates[d]?n=this._templates[d]:this._templates[d]=n=p(d,r);var f=(l-e)/(i-e);_.globalAlpha=f<.01?.01:f,_.drawImage(n,u,c),u<this._renderBoundaries[0]&&(this._renderBoundaries[0]=u),c<this._renderBoundaries[1]&&(this._renderBoundaries[1]=c),u+2*d>this._renderBoundaries[2]&&(this._renderBoundaries[2]=u+2*d),c+2*d>this._renderBoundaries[3]&&(this._renderBoundaries[3]=c+2*d)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],i=this._renderBoundaries[2]-t,a=this._renderBoundaries[3]-e,r=this._width,n=this._height,s=this._opacity,h=this._maxOpacity,o=this._minOpacity,d=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),r<t+i&&(i=r-t),n<e+a&&(a=n-e);for(var l=this.shadowCtx.getImageData(t,e,i,a),u=l.data,c=u.length,_=this._palette,f=3;f<c;f+=4){var p,g=u[f],m=4*g;if(m)p=0<s?s:g<h?g<o?o:g:h,u[f-3]=_[m],u[f-2]=_[m+1],u[f-1]=_[m+2],u[f]=d?_[m+3]:p}this.ctx.putImageData(l,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],i=this._max,a=this._min;return Math.abs(i-a)*(e/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},t}(),l=(i=!1,"canvas2d"===o.defaultRenderer&&(i=a),i),c=function(){for(var t={},e=arguments.length,i=0;i<e;i++){var a=arguments[i];for(var r in a)t[r]=a[r]}return t},r=function(){var h=function(){function t(){this.cStore={}}return t.prototype={on:function(t,e,i){var a=this.cStore;a[t]||(a[t]=[]),a[t].push(function(t){return e.call(i,t)})},emit:function(t,e){var i=this.cStore;if(i[t])for(var a=i[t].length,r=0;r<a;r++){(0,i[t][r])(e)}}},t}();function t(){var e,t,i,a,r=this._config=c(o,arguments[0]||{});if(this._coordinator=new h,r.plugin){var n=r.plugin;if(!o.plugins[n])throw new Error("Plugin '"+n+"' not found. Maybe it was not registered.");var s=o.plugins[n];this._renderer=new s.renderer(r),this._store=new s.store(r)}else this._renderer=new l(r),this._store=new d(r);t=(e=this)._renderer,i=e._coordinator,a=e._store,i.on("renderpartial",t.renderPartial,t),i.on("renderall",t.renderAll,t),i.on("extremachange",function(t){e._config.onExtremaChange&&e._config.onExtremaChange({min:t.min,max:t.max,gradient:e._config.gradient||e._config.defaultGradient})}),a.setCoordinator(i)}return t.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=c(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},t}(),n=function(t){return new r(t)};function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function h(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var i=Object.getOwnPropertyNames(e),a=0;a<i.length;a++){var r=i[a],n=Object.getOwnPropertyDescriptor(e,r);n&&n.configurable&&void 0===t[r]&&Object.defineProperty(t,r,n)}}(t,e))}var f=function(a){function r(t,e){s(this,r);var i=h(this,a.call(this,t,e));return i._el=g.DomUtil.createEl("div","maptalks-heatmap-layer"),i.cfg=e,i.cfg.container=i._el,i.cfg._max=1,i.cfg._min=0,i._data=[],i}return _(r,a),r.prototype.getData=function(){return this._data},r.prototype.getCfg=function(){return this.cfg},r.prototype.setData=function(t){this.cfg._max=t.max||this.cfg._max,this.cfg._min=t.min||this.cfg._min;for(var e=this.cfg.latField||"lat",i=this.cfg.lngField||"lng",a=this.cfg.valueField||"value",r=(t=t.data).length,n=[];r--;){var s=t[r],h={latlng:new g.Coordinate(s[e],s[i])};h[a]=s[a],s.radius&&(h.radius=s.radius),n.push(h)}return this._data=n,this.redraw()},r.prototype.addData=function(t){if(0<t.length)for(var e=t.length;e--;)this.addData(t[e]);else{var i=this.cfg.latField||"lat",a=this.cfg.lngField||"lng",r=this.cfg.valueField||"value",n=t,s={latlng:new g.Coordinate(n[i],n[a])};s[r]=n[r],this.cfg._max=Math.max(this.cfg._max,s[r]),this.cfg._min=Math.min(this.cfg._min,s[r]),n.radius&&(s.radius=n.radius),this._data.push(s)}return this.redraw()},r.prototype.onConfig=function(t){for(var e in t)if(this.options[e])return this.redraw();return this},r.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearHeatCache(),t.setToRedraw()),this},r.prototype.isEmpty=function(){return!this._data.length},r.prototype.clear=function(){return this._data=[],this.redraw(),this.fire("clear"),this},r.prototype._getHeatRadius=function(){return this._getRenderer()?this._getRenderer()._heatRadius:null},r}(g.Layer);f.registerJSONType("HeatLayer"),f.registerRenderer("canvas",function(t){function e(){return s(this,e),h(this,t.apply(this,arguments))}return _(e,t),e.prototype.draw=function(){var t=this.layer;this._map=this.getMap(),this.cfg=t.getCfg(),this._el=this.cfg.container;var e=this._map.getSize();this._width=e.width,this._height=e.height,this._el.style.width=e.width+"px",this._el.style.height=e.height+"px",this._el.style.position="absolute",this._origin=this._map._pointToContainerPoint(new g.Point(0,0)),this._map.getPanels().frontLayer.appendChild(this._el),this._data=t.getData(),this._heatmap||(this._heatmap=n(this.cfg)),this._draw(),this.completeRender()},e.prototype.drawOnInteracting=function(){this._draw()},e.prototype._draw=function(){if(this._map){var t=this._map.offsetPlatform();this._el.style[f.CSS_TRANSFORM]="translate("+-Math.round(t.x)+"px,"+-Math.round(t.y)+"px)",this._update()}},e.prototype._update=function(){var t={max:this.cfg._max,min:this.cfg._min,data:[]},e=this._map.getExtent(),i=this._map.getZoom(),a=Math.pow(2,i);if(0!==this._data.length){for(var r=[],n=this.cfg.scaleRadius?a:1,s=0,h=0,o=this.cfg.valueField,d=this._data.length;d--;){var l=this._data[d],u=l[o],c=new g.Coordinate(l.latlng);if(e.contains(c)){s=Math.max(u,s),h=Math.min(u,h);var _=this._map.coordinateToContainerPoint(c),f={x:Math.round(_.x),y:Math.round(_.y)};f[o]=u;var p=void 0;p=l.radius?l.radius*n:(this.cfg.radius||2)*n,f.radius=p,r.push(f)}}this.cfg.useLocalExtrema&&(t.max=s,t.min=h),t.data=r,this._heatmap.setData(t)}else this._heatmap&&this._heatmap.setData(t)},e.prototype.onZoomEnd=function(){delete this._heatViews,t.prototype.onZoomEnd.apply(this,arguments)},e.prototype.onResize=function(){this._origin=this._map._pointToContainerPoint(new g.Coordinate(0,0));var t=this._map.getSize();this._width===t.width&&this._height===t.height||(this._width=t.width,this._height=t.height,this._el.style.width=this._width+"px",this._el.style.height=this._height+"px",this._heatmap._renderer.setDimensions(this._width,this._height)),this._draw()},e.prototype.onRemove=function(){this.clearHeatCache(),this._map().getPanels().frontLayer.removeChild(this._el),delete this._heatmap},e.prototype.clearHeatCache=function(){delete this._heatViews},e}(g.renderer.CanvasRenderer)),f.CSS_TRANSFORM=function(){for(var t=document.createElement("div"),e=["transform","WebkitTransform","MozTransform","OTransform","msTransform"],i=0;i<e.length;i++){var a=e[i];if(void 0!==t.style[a])return a}return e[0]}(),t.HeatmapOverlay=f,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.HeatmapOverlay v1.0.0, requires maptalks@^0.40.5.")});